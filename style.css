// ===== LANGUAGES =====
const LANGS = [
  { v: 'Arabic',      l: 'ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',         rtl: true  },
  { v: 'Franco Arabic', l: 'ğŸ”¤ ÙØ±Ø§Ù†ÙƒÙˆ Ø¹Ø±Ø¨ÙŠ',     rtl: false },
  { v: 'English',     l: 'ğŸ‡¬ğŸ‡§ English',          rtl: false },
  { v: 'French',      l: 'ğŸ‡«ğŸ‡· FranÃ§ais',         rtl: false },
  { v: 'Spanish',     l: 'ğŸ‡ªğŸ‡¸ EspaÃ±ol',          rtl: false },
  { v: 'German',      l: 'ğŸ‡©ğŸ‡ª Deutsch',          rtl: false },
  { v: 'Italian',     l: 'ğŸ‡®ğŸ‡¹ Italiano',         rtl: false },
  { v: 'Portuguese',  l: 'ğŸ‡µğŸ‡¹ PortuguÃªs',        rtl: false },
  { v: 'Russian',     l: 'ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹',          rtl: false },
  { v: 'Chinese',     l: 'ğŸ‡¨ğŸ‡³ ä¸­æ–‡',              rtl: false },
  { v: 'Japanese',    l: 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª',            rtl: false },
  { v: 'Korean',      l: 'ğŸ‡°ğŸ‡· í•œêµ­ì–´',            rtl: false },
  { v: 'Turkish',     l: 'ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e',           rtl: false },
  { v: 'Persian',     l: 'ğŸ‡®ğŸ‡· ÙØ§Ø±Ø³ÛŒ',            rtl: true  },
  { v: 'Urdu',        l: 'ğŸ‡µğŸ‡° Ø§Ø±Ø¯Ùˆ',             rtl: true  },
  { v: 'Hindi',       l: 'ğŸ‡®ğŸ‡³ à¤¹à¤¿à¤¨à¥à¤¦à¥€',           rtl: false },
  { v: 'Hebrew',      l: 'ğŸ‡®ğŸ‡± ×¢×‘×¨×™×ª',            rtl: true  },
  { v: 'Dutch',       l: 'ğŸ‡³ğŸ‡± Nederlands',       rtl: false },
  { v: 'Polish',      l: 'ğŸ‡µğŸ‡± Polski',           rtl: false },
  { v: 'Swedish',     l: 'ğŸ‡¸ğŸ‡ª Svenska',          rtl: false },
  { v: 'Greek',       l: 'ğŸ‡¬ğŸ‡· Î•Î»Î»Î·Î½Î¹ÎºÎ¬',         rtl: false },
  { v: 'Indonesian',  l: 'ğŸ‡®ğŸ‡© Bahasa Indonesia', rtl: false },
  { v: 'Thai',        l: 'ğŸ‡¹ğŸ‡­ à¸ à¸²à¸©à¸²à¹„à¸—à¸¢',          rtl: false },
  { v: 'Vietnamese',  l: 'ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t',       rtl: false },
  { v: 'Ukrainian',   l: 'ğŸ‡ºğŸ‡¦ Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°',        rtl: false },
  { v: 'Swahili',     l: 'ğŸ‡°ğŸ‡ª Kiswahili',        rtl: false },
];

// ===== STATE =====
let busy = false;
let outputResult = '';

// ===== INIT =====
window.addEventListener('DOMContentLoaded', () => {
  populateSelects();
  onLangChange();
  document.getElementById('inputText').addEventListener('input', updateCharCount);
  document.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') doTranslate();
  });
});

function populateSelects() {
  const src = document.getElementById('srcLang');
  const tgt = document.getElementById('tgtLang');
  LANGS.forEach((lang, i) => {
    src.innerHTML += `<option value="${lang.v}" ${i === 0 ? 'selected' : ''}>${lang.l}</option>`;
    tgt.innerHTML += `<option value="${lang.v}" ${i === 2 ? 'selected' : ''}>${lang.l}</option>`;
  });
}

// ===== LANG CHANGE =====
function onLangChange() {
  const src = document.getElementById('srcLang').value;
  const tgt = document.getElementById('tgtLang').value;
  const si = LANGS.find(l => l.v === src);
  const ti = LANGS.find(l => l.v === tgt);
  const inp = document.getElementById('inputText');
  const out = document.getElementById('outputText');

  document.getElementById('inLabel').textContent  = src;
  document.getElementById('outLabel').textContent = tgt;

  inp.setAttribute('dir', si?.rtl ? 'rtl' : 'ltr');
  out.setAttribute('dir', ti?.rtl ? 'rtl' : 'ltr');

  const placeholders = {
    'Arabic':        'Ø§ÙƒØªØ¨ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§â€¦',
    'Franco Arabic': 'Ekteb henaâ€¦ e.g. ana ta3ban awy',
    'Persian':       'Ù…ØªÙ† Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯â€¦',
    'Urdu':          'ÛŒÛØ§Úº Ù…ØªÙ† Ù„Ú©Ú¾ÛŒÚºâ€¦',
    'Hebrew':        '×›×ª×•×‘ ××ª ×”×˜×§×¡×˜ ×›××Ÿâ€¦',
  };
  inp.placeholder = placeholders[src] || `Type your ${src} text hereâ€¦`;
  updateCharCount();
}

// ===== SWAP =====
function swapLangs() {
  const srcSel = document.getElementById('srcLang');
  const tgtSel = document.getElementById('tgtLang');
  const prevSrc = srcSel.value;
  const prevTgt = tgtSel.value;
  const prevOut = outputResult;

  srcSel.value = prevTgt;
  tgtSel.value = prevSrc;
  onLangChange();

  if (prevOut) {
    document.getElementById('inputText').value = prevOut;
    setOutput('');
    outputResult = '';
    document.getElementById('outFoot').textContent = '';
  }
  updateCharCount();
}

// ===== CHAR COUNT =====
function updateCharCount() {
  const v = document.getElementById('inputText').value;
  const src = document.getElementById('srcLang').value;
  const si = LANGS.find(l => l.v === src);
  document.getElementById('charCount').textContent = `${v.length} ${si?.rtl ? 'Ø­Ø±Ù' : 'chars'}`;
}

// ===== COPY =====
async function doCopy(which) {
  const text = which === 'in'
    ? document.getElementById('inputText').value
    : outputResult;
  if (!text) { showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ'); return; }
  const btnId = which === 'in' ? 'cpIn' : 'cpOut';
  try {
    await navigator.clipboard.writeText(text);
    const b = document.getElementById(btnId);
    b.textContent = 'âœ“'; b.classList.add('ok');
    setTimeout(() => { b.textContent = 'â§‰'; b.classList.remove('ok'); }, 1600);
  } catch { showToast('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®'); }
}

// ===== CLEAR =====
function clearAll() {
  document.getElementById('inputText').value = '';
  setOutput('');
  outputResult = '';
  document.getElementById('outFoot').textContent = '';
  updateCharCount();
}

// ===== API KEY TOGGLE =====
function toggleKey() {
  const inp = document.getElementById('apiKey');
  inp.type = inp.type === 'password' ? 'text' : 'password';
}

// ===== PROMPT BUILDER =====
function buildPrompt(text, src, tgt) {
  if (src === 'Franco Arabic')
    return `You are an expert in Egyptian Franco Arabic (Arabizi). Translate the following to ${tgt}. Return ONLY the translation.\nConventions: 3=Ø¹, 2=Ø£, 7=Ø­, 5=Ø®\nText: ${text}`;
  if (tgt === 'Franco Arabic')
    return `You are an expert in Egyptian Franco Arabic (Arabizi). Convert the following ${src} to Arabizi. Return ONLY the Arabizi.\nConventions: 3=Ø¹, 2=Ø£, 7=Ø­, 5=Ø®\nText: ${text}`;
  return `Translate from ${src} to ${tgt}. Return ONLY the translation, nothing else.\nText: ${text}`;
}

// ===== OUTPUT HELPERS =====
function setOutput(html) {
  document.getElementById('outputText').innerHTML = html || '<span class="ph">Ø³ØªØ¸Ù‡Ø± Ø§Ù„ØªØ±Ø¬Ù…Ø© Ù‡Ù†Ø§â€¦</span>';
}

function typeWrite(text) {
  const out = document.getElementById('outputText');
  out.textContent = '';
  const cur = document.createElement('span');
  cur.className = 'blink';
  const speed = Math.max(5, Math.min(20, 1800 / text.length));
  let i = 0;
  function tick() {
    if (i < text.length) {
      out.textContent = text.slice(0, ++i);
      out.appendChild(cur);
      setTimeout(tick, speed);
    } else {
      out.textContent = text;
      const tgt = document.getElementById('tgtLang').value;
      const ti = LANGS.find(l => l.v === tgt);
      document.getElementById('outFoot').textContent = `${text.length} ${ti?.rtl ? 'Ø­Ø±Ù' : 'chars'}`;
    }
  }
  tick();
}

// ===== TOAST =====
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// ===== TRANSLATE =====
async function doTranslate() {
  if (busy) return;

  const apiKey = document.getElementById('apiKey').value.trim();
  if (!apiKey) { showToast('ğŸ”‘ Ø£Ø¯Ø®Ù„ Anthropic API Key Ø£ÙˆÙ„Ø§Ù‹'); return; }

  const text = document.getElementById('inputText').value.trim();
  if (!text) { showToast('Ø§ÙƒØªØ¨ Ù†ØµØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹'); return; }

  const src = document.getElementById('srcLang').value;
  const tgt = document.getElementById('tgtLang').value;
  if (src === tgt) { showToast('Ø§Ø®ØªØ± Ù„ØºØªÙŠÙ† Ù…Ø®ØªÙ„ÙØªÙŠÙ†'); return; }

  busy = true;
  outputResult = '';
  const btn = document.getElementById('trBtn');
  btn.disabled = true;
  document.getElementById('btnContent').innerHTML = '<span class="spinner"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø©â€¦';
  document.getElementById('outputText').innerHTML = '<span class="blink"></span>';
  document.getElementById('outFoot').textContent = '';

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-allow-browser': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 2000,
        messages: [{ role: 'user', content: buildPrompt(text, src, tgt) }]
      })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error?.message || 'API Error');

    const result = (data.content?.[0]?.text || '').trim();
    outputResult = result;

    const ti = LANGS.find(l => l.v === tgt);
    document.getElementById('outputText').setAttribute('dir', ti?.rtl ? 'rtl' : 'ltr');
    typeWrite(result);

  } catch (err) {
    setOutput('');
    if (err.message && err.message.includes('401'))
      showToast('ğŸ”‘ API Key ØºÙ„Ø· Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ');
    else if (err.message && err.message.includes('429'))
      showToast('âš ï¸ ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ØŒ Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹');
    else
      showToast('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù€ API Key');
    console.error(err);
  } finally {
    busy = false;
    btn.disabled = false;
    document.getElementById('btnContent').innerHTML = 'ğŸŒ &nbsp; ØªØ±Ø¬Ù… Ø§Ù„Ø¢Ù†';
  }
}
